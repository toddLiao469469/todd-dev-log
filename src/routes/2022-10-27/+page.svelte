<!-- auto-generated by QWER -->
<script lang="ts">
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  import Post from '$lib/layouts/post.svelte';
  import ImgZoom from '$lib/components/image_zoom.svelte';
  import Video from '$lib/components/video.svelte';
  import CodeCopy from '$lib/components/code_copy.svelte';
  import InfoBox from '$lib/components/info_box.svelte';
</script>

<Post>
  <article slot="post_content">
    <p>
      大概從2021年底左右就打算要學習Rust，主要是覺得這個語言的特性真的太酷了以及它在前端的影嚮力日益劇增讓我開始對它產生了興趣，斷斷續續自學了這麼久，總覺得還是需要寫些筆記讓自己印象更深刻一點。
    </p>
    <hr />
    <h3 id="wei4-shen2-me-hui4-xu1-yao4-ownership">
      <a href="#wei4-shen2-me-hui4-xu1-yao4-ownership">為什麼會需要ownership？</a>
    </h3>
    <p>
      最主要的原因應該是「在不使用GC的情況下，確保記憶體的安全性」，確實GC對於開發者來說是一個相當方便的功能，但這也是必須犧牲部分效能且會有一個較為肥大的runtime所換來的。
    </p>
    <p>
      所以Rust使用了ownership來當作控制記憶體的手段，讓我們可以在靜態編譯期間能夠得知哪些記憶體操作會有風險而不是runtime時才去做檢查，這在某種程度上讓魚與熊掌都能兼得，但大前提是要能通過Rust的編譯器XD。
    </p>
    <h3 id="suo3-yi3-dao4-di3-shen2-me-shi4-ownership">
      <a href="#suo3-yi3-dao4-di3-shen2-me-shi4-ownership">所以到底什麼是ownership？</a>
    </h3>
    <p>在開始說明前，ownership有三個主要的規則</p>
    <p>每一個值都有一個owner 每個值同時只能擁有一個owner 如果owner離開這個scope則這個值將會被丟棄(drop)</p>
    <h3 id="move-yu3-copy"><a href="#move-yu3-copy">move 與 copy</a></h3>
    <p>
      在rust裡固定記憶體長度的資料（可以理解成Primitive type，精確定義是放在stack裡的資料）在做 y = x
      等賦值的動作時都是採用copy。
    </p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">let</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{},{}"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5,5</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>但如果是String 這種不固定長度的type當我們 s2 = s1時會是採用 move</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">// 這段code無法通過編譯</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">let</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">;</span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}, world!"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      當執行完第二行後 String::from(“hello”)的所有權已經轉移給s2了， 所以在第三行，我們再一次使用
      <code class="inline-code-block">s1</code>
       就會發生錯誤。
    </p>
    <p>
      要解釋這件事情首先我們要先知道 String是會被存放在heap
      裡，所以我們變數並不會存放值而是「heap中存放該值的記憶體地址」。所以我們在做 s2=s1 就是將s1
      所存放的記憶體位置給了s2 但為什麼不是直接複製給s2呢？
    </p>
    <p>回想一下最一開始說的三大規則的第二條「每個變數同時只能有一個owner」。</p>
    <p>
      至於為什麼需要避免同一個變數擁有兩個owner呢？就是為了避免當這個scope結束後這兩個owner都會進行drop，也就是釋放記憶體位置進而導致「double
      free error」的發生。
    </p>
    <h3 id="ownership-yu3-function"><a href="#ownership-yu3-function">ownership與function</a></h3>
    <p>前面有提到離開scope就會進行drop，以下面的code為例</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">//這段code無法通過編譯</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">foo</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}, world!"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      乍看之下沒什麼問題但其實這段code無法通過編譯，因為當 <code class="inline-code-block">foo&lpar;&rpar;</code>
      執行完畢後，
      <code class="inline-code-block">s1</code>
      的記憶體就會被釋放了，所以
      <code class="inline-code-block">println!&lpar;“&lcub;&rcub;, world!”, s1&rpar;;</code>
       並無法正確執行。
    </p>
    <p>而rust的編譯器也告訴我們原因了</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">error<span class="token punctuation">[</span><span class="token constant">E0382</span><span class="token punctuation">]</span><span class="token punctuation">:</span> borrow of moved value<span class="token punctuation">:</span> &#96;s1&#96;</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"> <span class="token operator">-</span><span class="token punctuation">-></span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token number">28</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">|</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">5</span> <span class="token operator">|</span>     <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">|</span>         <span class="token operator">-</span><span class="token operator">-</span> <span class="token keyword">move</span> occurs because &#96;s1&#96; has <span class="token keyword">type</span> &#96;<span class="token class-name">String</span>&#96;<span class="token punctuation">,</span> which does not implement the &#96;<span class="token class-name">Copy</span>&#96; <span class="token keyword">trait</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token type-definition class-name">6</span> <span class="token operator">|</span>     <span class="token function">foo</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">|</span>         <span class="token operator">-</span><span class="token operator">-</span> value moved here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">7</span> <span class="token operator">|</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">8</span> <span class="token operator">|</span>     <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}, world!"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">|</span>                            <span class="token operator">^</span><span class="token operator">^</span> value borrowed here after <span class="token keyword">move</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">|</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">=</span> note<span class="token punctuation">:</span> this error originates <span class="token keyword">in</span> the <span class="token keyword">macro</span> &#96;<span class="token variable">&#36;crate</span><span class="token punctuation">::</span>format_args_nl&#96; which comes from the expansion of the <span class="token keyword">macro</span> &#96;println&#96; <span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token class-name">Nightly</span> builds<span class="token punctuation">,</span> run with <span class="token operator">-</span><span class="token class-name">Z</span> <span class="token keyword">macro</span><span class="token operator">-</span>backtrace <span class="token keyword">for</span> more info<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> &#96;rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0382</span>&#96;<span class="token punctuation">.</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">error<span class="token punctuation">:</span> could not compile &#96;playground&#96; due to previous error</div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>從這些訊息我們能知道 s1 被move到 foo 裡的 word ，然後執行結束記憶體釋放最後s1是沒有東西的。</p>
    <p>那我們能怎麼修正這個問題？</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    word <span class="token comment">// 沒有分號的這種寫法相當等於return word;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 預設是immutable所以是用shadowing</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}, world!"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>最直覺想到會是那把word再傳出來然後用值接住就好了，也許你會覺得這樣已經夠彆扭了，那如果我今天是要計算字數呢？</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">get_len</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">-></span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> length <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">(</span>word<span class="token punctuation">,</span>length<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"HELLO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token punctuation">(</span>s2<span class="token punctuation">,</span>s2_len<span class="token punctuation">)</span><span class="token operator">=</span> <span class="token function">get_len</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"s2:{} ,length={} "</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span>s2_len<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      會發現為了所有權我需要多回傳那個變數本身，但其實Rust有提供其他手段讓我們可以把「變數借出去」。
      這部分就留到下篇文章再繼續說明了。
    </p>
    <hr />
    <p>參考資料：</p>
    <ol>
      <li>
        <a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html" rel="external">
          What is Ownership? — The Rust Programming Language (rust-lang.org)
        </a>
      </li>
      <li>
        <a href="https://magiclen.org/rust-ownership/" rel="external">
          Rust 學習之路─第四章：瞭解擁有權(Ownership) | MagicLen
        </a>
      </li>
    </ol>
  </article>
</Post>
