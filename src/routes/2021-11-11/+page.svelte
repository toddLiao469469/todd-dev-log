<!-- auto-generated by QWER -->
<script lang="ts">
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  import Post from '$lib/layouts/post.svelte';
  import ImgZoom from '$lib/components/image_zoom.svelte';
  import Video from '$lib/components/video.svelte';
  import CodeCopy from '$lib/components/code_copy.svelte';
  import InfoBox from '$lib/components/info_box.svelte';
</script>

<Post>
  <article slot="post_content">
    <p>這陣子陸續把現有的專案從 Ant Design 的Form （以下簡稱ADF）改為使用 React Hook Form （以下簡稱RHF）原因有：</p>
    <p>先打個預防針「有些原因不是缺點，只是剛好不太符合現有專案需求」</p>
    <p>
      ADF客製樣式會很麻煩，本身有太多內建的樣式。 ADF在綁定複雜的客製元件時較為麻煩。 RHF的type系統比ADF好很多。
      詳細說明及遷移過程可能會再寫一篇文章，這篇文章主要是要記錄最近在實作RHF上遇到坑。
    </p>
    <h3 id="cong2-useform-reset-fa1-xian4-de-keng1">
      <a href="#cong2-useform-reset-fa1-xian4-de-keng1">從useForm reset發現的坑</a>
    </h3>
    <p>RHF的 reset 主要有兩種功用一個是回到預設值，一個是將 Form 重設為特定的值。</p>
    <p>
      第一個功能比較不用說明，第二個通常是會用在當「這個 Form 的預設值是
      asynchronous」，所以我們無法在Form初始化時將我們希望的預設值丟進去，就會是在useEffect裡將await到的值放入 reset 。
    </p>
    <p>
      這次遇到的問題遇到某些component在正常的操作下都沒問題，像是基本的輸入、取值等等。但如果遇到reset就是無法正常地觸發re-render。
    </p>
    <h3 id="bang3-ding4-yuan2-jian4"><a href="#bang3-ding4-yuan2-jian4">綁定元件</a></h3>
    <p>
      先稍微介紹一下RHF，通常是會使用 useForm
      去建立Form的instance，也可以利用這個hook去設定預設值或者其他操作。而useForm有回傳兩個將元件與Form綁定的方式：register
      以及control
    </p>
    <p>基本上我們的 input 元件都會使用register 進行綁定。</p>
    <div class="code-block  ">
      <CodeCopy>
        <pre><code
            class="language-jsx">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      而 <code class="inline-code-block">control</code>
       就較為麻煩
    </p>
    <div class="code-block  ">
      <CodeCopy>
        <pre><code
            class="language-jsx">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Controller</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>name<span class="token punctuation">'</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">control</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>control<span class="token punctuation">}</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">render</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>field<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>field<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span> <span class="token punctuation">}</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">/></span></span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      基本上就是利用 render props 讓這個元件可以被 <code class="inline-code-block">Form</code>
      操控。在RHF的文件裡有說到有些第三方的 controlled component需要使用
      <code class="inline-code-block">Controller</code>
       來進行包裝才能被使用。
    </p>
    <h3 id="hui2-dao4-zhe4-ci4-de-wen4-ti2"><a href="#hui2-dao4-zhe4-ci4-de-wen4-ti2">回到這次的問題</a></h3>
    <p>我們使用了 chakra-ui 來當作我們的元件庫，一直以來使用都沒什麼問題 直到我們做了以下事情：</p>
    <div class="code-block  ">
      <CodeCopy>
        <pre><code
            class="language-jsx">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">const</span> <span class="token function-variable function">CustomizedInput</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">props</span><span class="token operator">:</span> InputProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">return</span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">marginBottom</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0px<span class="token punctuation">'</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">backgroundColor</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>White<span class="token punctuation">}</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">border</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">1px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">&#36;{</span>Gray500<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">}</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token attr-name">borderRadius</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>8px<span class="token punctuation">'</span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"> <span class="token punctuation">/></span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>基本上就是我們將常用的樣式包裝成一個共用input，而在這個例子中的props就會將我們的register相關的行為注入進去。</p>
    <p>一個簡單還原的Demo:</p>
    <iframe
      src="https://codesandbox.io/embed/react-hook-form-demo-p5hd5?fontsize=14&hidenavigation=1&theme=dark"
      style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
      title="react-hook-form-demo"
      allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
      sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" />

    <p>有四種input：</p>
    <ol>
      <li>
        使用 <code class="inline-code-block">register</code>
        去綁定
        <code class="inline-code-block">Input</code>
      </li>
      <li>
        使用 <code class="inline-code-block">register</code>
        去綁定使用
        <code class="inline-code-block">React.forwardRef</code>
        的
        <code class="inline-code-block">CustomInput</code>
      </li>
      <li>
        使用 <code class="inline-code-block">control</code>
        去綁定
        <code class="inline-code-block">CustomInput</code>
      </li>
      <li>
        使用 <code class="inline-code-block">register</code>
        去綁定不經過
        <code class="inline-code-block">React.forwardRef</code>
        的
        <code class="inline-code-block">CustomInput</code>
      </li>
    </ol>
    <p>
      會發現只有 4. 沒有被reset到初始值，所以我們可以合理懷疑這個問題應該跟
      <code class="inline-code-block">CustomInput</code>
      這種包裝方式有很大關聯。
    </p>
    <p>但為什麼？其實console已經給了答案了</p>
    <p>
      <code class="inline-code-block">
        Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use
        React.forwardRef&lpar&rpar
      </code>
    </p>
    <p>
      第一個疑問是為什麼會有
      <code class="inline-code-block">ref</code>
      ？這邊就要回去看RHF的source ，這邊會看到register有回傳
      <code class="inline-code-block">ref</code>
      ，簡單來看就是
      <code class="inline-code-block">register</code>
      時就會順便註冊這個
      <code class="inline-code-block">ref</code>
      到input。
    </p>
    <p>
      所以在我們的例子中就將
      <code class="inline-code-block">ref</code>
      傳給了CustomInput，但因為Functional component本身是沒有
      <code class="inline-code-block">ref</code>
      的，導致這個傳入的ref並沒有作用。
    </p>
    <h3 id="forwardref"><a href="#forwardref">forwardRef</a></h3>
    <p>
      那我們就來看看為什麼使用了 <code class="inline-code-block">forwardRef</code>
      的
      <code class="inline-code-block">CustomInput</code>
       可以達成我們的需求。
    </p>
    <p>官方文件：傳送 Ref — React</p>
    <p>
      首先我們要先知道 <code class="inline-code-block">ref</code>
      是一個保留字詞，所以是不能被當作props的命名。這也是會發生這個問題的其中一個原因，所以ref被傳下來後沒被綁定在
      <code class="inline-code-block">CustomInput</code>
      上也無法在
      <code class="inline-code-block">&lcub...props&rcub</code>
      中 並無法取出
      <code class="inline-code-block">ref</code>
       的。
    </p>
    <p>
      其實有透過其他命名，像是將這個prop命名改為
      <code class="inline-code-block">customRef</code>
      之類的，然後藉此規避掉關鍵字問題，但這種方式跟
      <code class="inline-code-block">forwardRef</code>
       的比較並不在本篇文的討論範圍。
    </p>
    <p>
      那我們就來看一下 <code class="inline-code-block">forwardRef</code>
       如何使用。
    </p>
    <div class="code-block  ">
      <CodeCopy>
        <pre><code
            class="language-jsx">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token function">forwardRef</span><span class="token punctuation">(</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span>ref</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Input</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">)</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      在創建component時，我們透過wrap一層 <code class="inline-code-block">forwardRef</code>
      讓
      <code class="inline-code-block">ref</code>
       可以被取出並傳遞到下層。
    </p>
    <p>從我們能看到的簡單流程就是這樣：</p>
    <p>
      我們在呼叫
      <code class="inline-code-block">register</code>
      時會將
      <code class="inline-code-block">ref</code>
      傳入到
      <code class="inline-code-block">CustomInput</code>
      React 會將
      <code class="inline-code-block">ref</code>
      當作
      <code class="inline-code-block">forwardRef</code>
      裡的function中的第二個變數 我們藉由把這個
      <code class="inline-code-block">ref</code>
      當作 JSX attribute 來傳遞到更下面的
      <code class="inline-code-block">&lt;Input ref=&lcubref&rcub&gt;</code>
      而也許會有人想問為什麼chakra的
      <code class="inline-code-block">Input</code>
      可以接收
      <code class="inline-code-block">ref</code>
      ，它應該不是原生的html tag啊？而答案當然就是「他也用了
      <code class="inline-code-block">forwardRef</code>
      」 source code
    </p>
    <p>到這其實這個坑也算解的差不多了。</p>
    <p>
      那至於為什麼 <code class="inline-code-block">Controller</code>
      為什麼可以解決這個問題呢？簡單的解釋是：
      <code class="inline-code-block">Controller</code>
      在render props裡用了另外一個custom hook ：
      <code class="inline-code-block">useController</code>
      內部有自己的context，所以就算
      <code class="inline-code-block">ref</code>
       沒有被傳遞到最下面的component也是能夠更改及讀取到狀態，那這樣的行為到底這算不算Bug我就沒深入研究了。
    </p>
    <h3 id="jie2-yu3"><a href="#jie2-yu3">結語</a></h3>
    <p>
      但也因為這個坑我發現另外一件事，還記得我最一開始說這是因爲 <code class="inline-code-block">reset</code>
       而發現的嗎？
    </p>
    <p>
      我在codesandbox實作這個demo時發現，為什麼一般onChange也會失效了？後來才知道這是RHF的版本問題，codesandbox裡使用是最新版(寫文當下是：7.19.2)，而公司內的專案使用的是7.12.2，而7.12.2裡就算我不用forwardRef
      狀態也是能正常被讀取跟更改。
    </p>
    <p>
      但我也沒有深入比對這兩個版本中到底差了哪些東西就是了，總之這意外的讓我先往 <code class="inline-code-block">
        reset
      </code>
      這個api實作去找問題。而發現到
      <code class="inline-code-block">reset</code>
      中是有操作到
      <code class="inline-code-block">ref</code>
      之後才再去看
      <code class="inline-code-block">register</code>
       的實作來找到這個問題。
    </p>
    <p>
      其中一個原因也是我很少在操作 <code class="inline-code-block">ref</code>
      ，以至於在遇到這個坑之前我不知道
      <code class="inline-code-block">ref</code>
      是不能直接被使用
      <code class="inline-code-block">ref</code>
      這個名字在進行傳遞的，而且剛好之前在使用
      <code class="inline-code-block">ref</code>
      時都剛好有額外的命名而規避掉這個坑。直到
      <code class="inline-code-block">register</code>
      自動傳入
      <code class="inline-code-block">ref</code>
       才讓我發現這件事情。
    </p>
    <h3 id="lan3-ren2-bao1"><a href="#lan3-ren2-bao1">懶人包</a></h3>
    <ol>
      <li>
        RHF會自動的傳入 <code class="inline-code-block">ref</code>
      </li>
      <li>
        在包裝第三方套件時請注意到
        <code class="inline-code-block">ref</code>
         的傳遞情況
      </li>
      <li>
        <code class="inline-code-block">ref</code>
        不能被直接傳遞，如果要傳遞
        <code class="inline-code-block">ref</code>
        到下層component要就是用其他名字又或者使用
        <code class="inline-code-block">forwardRef</code>
      </li>
    </ol>
  </article>
</Post>
