<!-- auto-generated by QWER -->
<script lang="ts">
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  import Post from '$lib/layouts/post.svelte';
  import ImgZoom from '$lib/components/image_zoom.svelte';
  import Video from '$lib/components/video.svelte';
  import CodeCopy from '$lib/components/code_copy.svelte';
  import InfoBox from '$lib/components/info_box.svelte';
</script>

<Post>
  <article slot="post_content">
    <p>
      在
      <a href="../2022-10-27/index.md">上一篇</a>
      裡的最後一個程式碼有提到因為所有權，導致我們在實作function及使用上都造成一定程度的不方便。
    </p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">get_len</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> length <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">(</span>word<span class="token punctuation">,</span>length<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"HELLO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token punctuation">(</span>s2<span class="token punctuation">,</span>s2_len<span class="token punctuation">)</span><span class="token operator">=</span> <span class="token function">get_len</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"s2:{} ,length={} "</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span>s2_len<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      那我們該如何改善這段程式碼呢？ 首先我們希望把 <code class="inline-code-block">
        -&gt; &lpar;String, usize&rpar;
      </code>
      變成
      <code class="inline-code-block">-&gt; usize</code>
      就好，畢竟我們只是要計算字數而已。 再來就不用
      <code class="inline-code-block">shaowing</code>
      變數，也能夠直接在
      <code class="inline-code-block">println!</code>
      裡繼續使用
      <code class="inline-code-block">s2</code>
    </p>
    <hr />
    <h3 id="borrowing"><a href="#borrowing">Borrowing</a></h3>
    <p>我們只需要將程式碼稍稍改寫：</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">get_len</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> length <span class="token operator">=</span> word<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    length</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"HELLO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> s2_len <span class="token operator">=</span> <span class="token function">get_len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"s2:{} ,length={} "</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span>s2_len<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      當我們使用 <code class="inline-code-block">&amp;</code>
      運算子時意思是我們要去取 reference，所以
      <code class="inline-code-block">&amp;s2</code>
      就是去取得
      <code class="inline-code-block">s2</code>
       的reference。 而所謂rust中的reference，我覺得比較像c++中的pointer（指標），感覺像是指向變數記憶體位置的一個代稱。
    </p>
    <p>
      而當我們將 <code class="inline-code-block">&amp;s2</code>
      傳入到
      <code class="inline-code-block">get_len</code>
      時，因為我們是將
      <code class="inline-code-block">s2</code>
       的reference傳入而不是將他的變數傳進去，所以並不會發生move，而這個行為就被稱為borrowing（借用）。
    </p>
    <p>
      可以發現我們不用再多 <code class="inline-code-block">return s2</code>
      本身，只需要將 word的type改為
      <code class="inline-code-block">&amp;String</code>
      來表示我們要接收的一是個string reference。 而在rust中我們在操作 reference
      type大多數時刻，都跟我們在操作一般的型別一樣。我們可以直接
      <code class="inline-code-block">word.len&lpar;&rpar;</code>
      但在某些情況下我們可會需要使用到
      <code class="inline-code-block">*</code>
       這個運算子來 dereference （解參考）
    </p>
    <h3 id="mutable-reference"><a href="#mutable-reference">Mutable reference</a></h3>
    <p>
      在rust中我們如果讓一個變數是可以被更改的都需要加上 <code class="inline-code-block">mut</code>
      這個關鍵字，而reference也是一樣，如果我要建立一個 mutable reference 我們就必須使用
      <code class="inline-code-block">&amp;mut</code>
    </p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">push_string</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    word<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token keyword">mut</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">push_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span> <span class="token comment">// testtest</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      從上面的例子得知，我們必須將參數type改為 <code class="inline-code-block">&amp;mut</code>
      String且我們也必須在傳入函數時使用
      <code class="inline-code-block">&amp;mut</code>
      ，需要注意的一點是必須是
      <code class="inline-code-block">let mut</code>
      的變數才能建立
      <code class="inline-code-block">&amp;mut</code>
      。
    </p>
    <p>在rust中為了避免Data race 所以每個變數只能擁有一個mutable reference</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">// This code does not compile</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">push_string</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    word<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token keyword">mut</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> immut_a <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> mut_a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">push_string</span><span class="token punctuation">(</span>mut_a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{} , {}"</span><span class="token punctuation">,</span>a <span class="token punctuation">,</span>immut_a<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>編譯器會很貼心地告訴我們，哪裡重複宣告了mutable reference</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">error<span class="token punctuation">[</span><span class="token constant">E0499</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow &#96;a&#96; <span class="token keyword">as</span> mutable more than once at a time</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">-</span><span class="token punctuation">-></span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">17</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">9</span>  <span class="token operator">|</span>     <span class="token keyword">let</span> mut_a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> first mutable borrow occurs here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">10</span> <span class="token operator">|</span>     <span class="token keyword">let</span> mut_b <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                 <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> second mutable borrow occurs here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">...</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">13</span> <span class="token operator">|</span>     <span class="token function">push_string</span><span class="token punctuation">(</span>mut_a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> first borrow later used here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> &#96;rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0499</span>&#96;<span class="token punctuation">.</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>而且也不能同時擁有mutable reference和immutable reference</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">// This code doesn't compile</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">push_string</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    word<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token keyword">mut</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> immut_a <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> mut_a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">push_string</span><span class="token punctuation">(</span>mut_a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{} , {}"</span><span class="token punctuation">,</span>a <span class="token punctuation">,</span>immut_a<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">error<span class="token punctuation">[</span><span class="token constant">E0502</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow &#96;a&#96; <span class="token keyword">as</span> mutable because it is also borrowed <span class="token keyword">as</span> immutable</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token operator">-</span><span class="token punctuation">-></span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">17</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">9</span>  <span class="token operator">|</span>     <span class="token keyword">let</span> immut_a <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                   <span class="token operator">-</span><span class="token operator">-</span> immutable borrow occurs here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">10</span> <span class="token operator">|</span>     <span class="token keyword">let</span> mut_a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                 <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> mutable borrow occurs here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">...</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token number">14</span> <span class="token operator">|</span>     <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{} , {}"</span><span class="token punctuation">,</span>a <span class="token punctuation">,</span>immut_a<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">   <span class="token operator">|</span>                           <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> immutable borrow later used here</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> &#96;rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0502</span>&#96;<span class="token punctuation">.</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">error<span class="token punctuation">:</span> could not compile &#96;playground&#96; due to previous error</div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      之所以不能允許同時擁有mutable及immutable的reference是因為這樣子那個宣告成immutable
      reference就不能確保他是immutable的了。
    </p>
    <p>但rust的編譯器有辦法判斷出各個reference的作用範圍，所以這樣子是可以的：</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-rust">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">push_string</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    word<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> <span class="token keyword">mut</span> a <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> immut_a <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{} , {}"</span><span class="token punctuation">,</span>a <span class="token punctuation">,</span>immut_a<span class="token punctuation">)</span><span class="token punctuation">;</span> </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    </div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">let</span> mut_a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> a<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">push_string</span><span class="token punctuation">(</span>mut_a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>mut_a<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      在第一次 <code class="inline-code-block">println!</code>
      後再也沒用到
      <code class="inline-code-block">immut_a</code>
       所以之後再宣告一個 mutable reference 是可以的。
    </p>
    <p>參考資料:</p>
    <ol>
      <li>
        <a href="https://magiclen.org/rust-ownership/" rel="external">
          Rust 學習之路─第四章：瞭解擁有權(Ownership) | MagicLen
        </a>
      </li>
      <li>
        <a
          href="https://jasonblog.github.io/note/Rust/rust-an-introduction-reference-and-borrow-checker.html"
          rel="external">
          給 C++ 使用者的 Rust 簡介：參考型別與 Borrow Checker | Jason note (jasonblog.github.io)
        </a>
      </li>
      <li>
        <a href="https://juejin.cn/post/7039590802275696676/" rel="external">
          写给前端看的Rust教程（5）Borrowing &amp; Ownership — 掘金 (juejin.cn)
        </a>
      </li>
      <li>
        <a href="https://blog.thoughtram.io/references-in-rust/" rel="external">
          References in Rust | Articles by thoughtram
        </a>
      </li>
      <li>
        <a href="https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html" rel="external">
          References and Borrowing — The Rust Programming Language (rust-lang.org)
        </a>
      </li>
    </ol>
  </article>
</Post>
